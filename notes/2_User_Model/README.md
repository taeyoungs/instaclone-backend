# 10 Create Account Part one

## log

- Prisma Schemaì— User model ì¶”ê°€ í›„ migrate
- Userì— ê´€í•œ typeDefs, Query, Mutationì„ ë‹´ì•„ë‘˜ í´ë” ì¶”ê°€
- Mutation: createAccount
- Query: seeProfile
- TypeDefs: User (password ì œì™¸, ì¼ë°˜ì ìœ¼ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìš”ì²­í•˜ëŠ” ì¼ì€ ì—†ìŒ)

## tips

## issue

- none

## dependencies

## devDependencies

# 11 Create Account Part two

## log

- schemaì— unique ì˜µì…˜ìœ¼ë¡œ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ì¼ ê²½ìš° DBê°€ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆë„ë¡ í•˜ì.

í•˜ì§€ë§Œ DB ì—ëŸ¬ëŠ” ì •ë§ ìµœí›„ì˜ ë°©ë²•ì´ë¯€ë¡œ Userê°€ DB ì—ëŸ¬ë¥¼ ë§Œë‚˜ê²Œ í•´ì„œëŠ” ì•ˆëœë‹¤. DB ì—ëŸ¬ì— ë„ˆë¬´ ì˜ì¡´í•˜ì§€ ë§ê³  DB ì—ëŸ¬ ì´ì „ì— ì½”ë“œ ìƒì—ì„œ ì—ëŸ¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤. Userê°€ DB ì—ëŸ¬ë¥¼ ë§Œë‚¬ë‹¤ëŠ” ê±´ í”„ë¡œê·¸ë˜ë¨¸ê°€ ê·¸ë§Œí¼ ì²´í¬í•˜ì§€ ì•Šì•˜ë‹¤ëŠ” ì´ì•¼ê¸°ì´ë‹¤.

- prisma client **findFirst**: ì¡°ê±´ì— ë§ëŠ” ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ë°˜í™˜
- DBì— ì ‘ê·¼í•˜ëŠ” client ë©”ì„œë“œëŠ” Promiseë¥¼ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ì‹¤í–‰ ìˆœì„œë¥¼ ë³´ì¥ë°›ê¸° ìœ„í•´ì„  async & awaitë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

## tips

## issue

- none

## dependencies

## devDependencies

# 12 Create Account Part three

## log

- hash password

ëˆ„êµ°ê°€ê°€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³´ê²Œ í•˜ëŠ” ê²ƒì€ ì‹«ì§€ë§Œ ë¹„ë°€ë²ˆí˜¸ëŠ” ê¸°ì–µí•  í•„ìš”ê°€ ìˆëŠ” ìƒí™©, ì´ë¥¼ ìœ„í•´ hashë¥¼ ì´ìš©í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€í˜•í•œë‹¤. ì¡°ê¸ˆ ë” ìì„¸íˆ ì •ë¦¬í•˜ìë©´ ê³„ì •ê³¼ ì†”íŠ¸(salt)/í•´ì‰¬ê°’(hash)ì„ ì €ì¥í•´ë‘ê³ , ì…ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ê°€ ë§ëŠ”ì§€ ì²´í¬í•  ë•Œ ë¹„ë°€ë²ˆí˜¸+ì†”íŠ¸ë¡œ í•´ì‰¬ê°’ê³¼ ê°™ì€ì§€ ë¹„êµí•œë‹¤. ê°™ì€ ì…ë ¥ê°’ì— ëŒ€í•œ ì¶œë ¥ê°’, ì¦‰ í•´ì‰¬ê°’ì€ ê°™ìœ¼ë¯€ë¡œ ë§ëŠ” íŒ¨ìŠ¤ì›Œë“œë¼ê³  í•  ìˆ˜ ìˆë‹¤.  
ë˜í•œ í•´ì‰¬í•¨ìˆ˜ëŠ” ë‹¨ë°©í–¥ í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì— ë¹„ë°€ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ë‹¤. ìš”ì¦˜ì— ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì´ ì‚¬ë¼ì§€ê³  ì¬ì„¤ì •ì´ ì¡´ì¬í•˜ëŠ” ì´ìœ ì´ë‹¤.

- bycrpt

í•´ì‹œ í•¨ìˆ˜ë¥¼ ë¹„ë¡¯í•œ ë‹¤ì–‘í•œ ë³´ì•ˆ ê´€ë ¨ í•¨ìˆ˜ë“¤ì„ ì œê³µí•´ì£¼ëŠ” íŒ¨í‚¤ì§€, bycrptì˜ hash ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë¹„ë°€ë²ˆí˜¸ì™€ ì†”íŠ¸ê°’ì´ ì…ë ¥ê°’ìœ¼ë¡œ ë“¤ì–´ê°„ í•´ì‰¬ê°’ì´ ë°˜í™˜ëœë‹¤.

## tips

- ë ˆì¸ë³´ìš° í…Œì´ë¸”

ì†”íŠ¸ê°€ ì—†ëŠ” ìƒí™©ì—ì„œ ë¯¸ë¦¬ í•´ì‰¬ê°’ì„ ë§Œë“¤ì–´ë†“ì€ ê²ƒì¸ë° í•´ì‰¬ê°’ì˜ ëª¨ë“  ê²½ìš°ì˜ ìˆ˜ë¥¼ ë‚˜ì—´í•´ë†“ì€ í…Œì´ë¸”ì´ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤.

- salt

ë ˆì¸ë³´ìš° í…Œì´ë¸” ê³µê²©ì„ ë§‰ê¸° ìœ„í•œ ëœë¤ ë¬¸ìì—´, ê° ìœ ì €ë§ˆë‹¤ ëœë¤í•˜ê²Œ ë§Œë“  ì†”íŠ¸ ë¬¸ìì—´ì„ ê°–ê²Œ ë˜ê³  ë¬¸ìì—´ì—” ì†Œë¬¸ì, ìˆ«ì ë“±ì´ í¬í•¨ë˜ì–´ ìˆì–´ ê²½ìš°ì˜ ìˆ˜ê°€ ì—„ì²­ë‚˜ê²Œ ì¦ê°€í•œë‹¤. ë ˆì¸ë³´ìš° í…Œì´ë¸”ì€ ì†”íŠ¸ê°€ ì—†ëŠ” ìƒí™©ì—ì„œ ë§Œë“¤ì–´ ë†“ì€ ê°’ë“¤ì¸ë° ì†”íŠ¸ê°€ ì¡´ì¬í•˜ëŠ” ìˆœê°„ ë ˆì¸ë³´ìš° í…Œì´ë¸”ì„ ìƒˆë¡œ ë§Œë“¤ì–´ì•¼ í•˜ê³  ì‚¬ìš©ìë§ˆë‹¤ ë‹¤ë¥¸ ì†”íŠ¸ê°’ì„ ê°€ì§€ê³  ìˆê¸° ë•Œë¬¸ì— 1ëª…ì˜ ìœ ì €ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•Œì•„ë‚´ê¸°ë„ í˜ë“¤ê²Œ ëœë‹¤.

## issue

- none

## dependencies

- bcrypt: ^5.0.1

## devDependencies

- @types/bcrypt: ^5.0.0

# 13 See Profile

## log

- async & await ë¬¸ë²•ì„ ì‚¬ìš©í•  ë•Œ ì—ëŸ¬ í•¸ë“¤ë§ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” try ~ catchë¬¸ì„ ì‚¬ìš©í•˜ì. Promiseë¥¼ ì‚¬ìš©í•  ë•Œ í›„ì† ì²˜ë¦¬ ë©”ì„œë“œ catchë¥¼ ì‚¬ìš©í•´ì„œ ì—ëŸ¬ë¥¼ ì¡ì•„ë‚´ë“¯ tryë¬¸ ì•ˆì—ì„œ ë°œìƒí•œ ì—ëŸ¬ë¥¼ catchë¬¸ì—ì„œ ë°›ì•„ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆë‹¤.
- OR í‚¤ì›Œë“œë¡œ ë™ì¼í•œ username/emailì˜ ì‚¬ìš©ì ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í–ˆê³  ì¡´ì¬í•œë‹¤ë©´ existingUser ë³€ìˆ˜ì— ë‹´ì•„ë‚´ë„ë¡ í–ˆë‹¤. existingUserì´ nullì´ ì•„ë‹ˆë¼ë©´ ì—ëŸ¬ë¥¼ ë˜ì ¸(`throw new Error()`) catchë¬¸ì—ì„œ ì—ëŸ¬ë¥¼ ë°˜í™˜ ë˜ëŠ” ì²˜ë¦¬ + ë°˜í™˜ì„ í•´ì£¼ì.

## tips

- `findUnique` ë©”ì„œë“œëŠ” prisma schemaì—ì„œ unique ì˜µì…˜ì´ ì„¤ì •ëœ ì»¬ëŸ¼ë§Œ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

## issue

- none

## dependencies

## devDependencies

# 14 Login and Refactor

## log

- loginì—ì„œ ì—ëŸ¬ë¥¼ í•¸ë“¤ë§í•˜ëŠ” ë°©ë²•ì´ seeProfileê³¼ëŠ” ì¡°ê¸ˆ ë‹¤ë¥¸ë° loginê³¼ ê°™ì´ ì—ëŸ¬ì˜ ë‚´ìš©ì„ ë‹´ì•„ ë°˜í™˜í•´ì¤Œìœ¼ë¡œì¨ ì´í›„ì— í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì´ë¥¼ í™”ë©´ì— í‘œì‹œí•´ì¤„ ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì— ë‹¨ìˆœíˆ ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œì„œ ë©ˆì¶”ê¸° ë³´ë‹¤ëŠ” í˜„ì¬ ìƒíƒœì™€ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ë‹´ì€ ê°ì²´ë¥¼ ë°˜í™˜í•´ì¤€ë‹¤. (seeProfileë„ ë‚˜ì¤‘ì— ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ì—ëŸ¬ í•¸ë“¤ë§í•  ì˜ˆì •)
- í”„ë¡ íŠ¸ì—”ë“œì™€ ë°±ì—”ë“œê°€ ë¶„ë¦¬ë˜ì–´ ìˆìœ¼ë‹ˆ Cookieì™€ Sessionì„ ì‚¬ìš©í•˜ê¸° ë³´ë‹¤ëŠ” JSON Web Tokenì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ ì²´í¬í•œë‹¤.

ì„œë²„ì—ì„œ JSON Web Tokenì„ ìƒì„±í•  ë•Œ ì„œëª…ì„ ì¶”ê°€í•˜ê²Œ ë˜ê³  í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° í† í°ì„ ë°›ê²Œ ëì„ ë•Œ ì„œëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ì—¬ ì„œë²„ì—ì„œ ë³´ë‚¸ í† í°ì´ ë§ëŠ”ì§€ í™•ì¸í•œë‹¤. í† í°ì˜ ëª©ì ì€ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ë‹´ì•„ì„œ ì´ë¥¼ ì£¼ê³  ë°›ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ **í† í° ì•ˆì— ì •ë³´ë¥¼ ë‹´ê³  í•´ë‹¹ í† í°ì´ ì„œë²„ì—ì„œ ì‚¬ì¸í•œ í† í°ì¸ì§€ í™•ì¸í•˜ëŠ” ê²ƒ**ì´ë‹¤.  
ë¬¼ë¡  ì„œë²„ì—ì„œ í† í°ì„ ì‚¬ì¸í•  ë•Œ ì‚¬ìš©í•˜ëŠ” KeyëŠ” ì ˆëŒ€ ê³µê°œë˜ì„  ì•ˆë˜ë¯€ë¡œ env íŒŒì¼ì— ë³´ê´€í•œë‹¤. ì¶”ê°€ë¡œ í† í°ì—ëŠ” ìœ íš¨ ê¸°ê°„ ë“± ë‹¤ì–‘í•œ ì˜µì…˜ì„ ì„¤ì •í•  ìˆ˜ë„ ìˆë‹¤.

- Resolver ì´ë¦„ìœ¼ë¡œ ë¦¬íŒ©í† ë§

ì ì  ë§ì•„ì§€ëŠ” typeDefsì™€ mutation, queryë¥¼ ëŒ€ë¹„í•˜ì—¬ ê¸°ì¡´ model ì´ë¦„ìœ¼ë¡œ ëœ í´ë” ì•ˆì— 3ê°€ì§€ë¥¼ ì‘ì„±í•œ êµ¬ì¡°ì—ì„œ í•œë²ˆ ë” ë¶„ë¦¬í•˜ì—¬ Resolver ì´ë¦„ìœ¼ë¡œ í´ë”ë¥¼ ìƒì„±í•œ ë’¤ typeDefs, mutation ê·¸ë¦¬ê³  queryë¥¼ ì‘ì„±í•´ì£¼ë„ë¡ í•˜ì. Divide and Conquer !

## tips

## issue

- none

## dependencies

## devDependencies

# 17 Authentication

## log

- ë¡œê·¸ì¸ë¶€í„° ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì‘ì—…ì„ ìš”ì²­í•˜ê¸°ê¹Œì§€ì˜ íë¦„

1. ì‚¬ìš©ìê°€ ì•„ì´ë””(í˜¹ì€ username, email)ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³´ë‚´ ë¡œê·¸ì¸ì„ ì‹œë„
2. DBì— ë‹´ê¸´ ì •ë³´ì™€ ì¼ì¹˜í•œë‹¤ë©´ í† í°ì„ ë°œí–‰í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì„œë²„ê°€ ì‘ë‹µ ë©”ì„¸ì§€ì— ë‹´ì•„ ë³´ë‚´ì¤€ë‹¤.
3. í† í°ì„ ë°›ì€ í´ë¼ì´ì–¸íŠ¸ëŠ” í† í°ì„ ì €ì¥í•´ë†“ì€ ë’¤ì— ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì‘ì—…ì„ ìš”ì²­í•  ë•Œë§ˆë‹¤ í† í°ì„ ê°™ì´ ë³´ë‚´ì¤€ë‹¤.
4. í† í°ì„ ë°›ì€ ì„œë²„ëŠ” ìì‹ ì´ ê°€ì§€ê³  ìˆëŠ” Keyë¥¼ ì´ìš©í•˜ì—¬ í† í°ì´ ë³€í˜•ëœì§€ í™•ì¸í•˜ê³  ë³€í˜•ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ í•œë‹¤.

- í† í°ì„ ì „ë‹¬í•˜ëŠ” ê°€ì¥ ê¸°ì´ˆì ì¸ ë°©ë²•ì—ëŠ” mutation argumentë¡œ ê°™ì´ ë³´ë‚´ì£¼ëŠ” ë°©ë²•ì´ ìˆë‹¤.

ì´ëŠ” í¸í•´ë³´ì¼ì§€ ëª°ë¼ë„ ëª¨ë“  mutation ìš”ì²­ ë˜ëŠ” í† í°ì´ í•„ìš”í•œ ëª¨ë“  ì‘ì—…ì— tokenì„ argumentë¡œ ì „ë‹¬í•´ì•¼í•˜ëŠ” ë¬¸ì œê°€ ìˆë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í† í°ì„ ë‹´ì•„ ë³´ë‚´ëŠ” ê³³ì€ request headerì˜ Authorizationì´ë‹¤. Authorizationì— í† í°ì˜ ì¢…ë¥˜ì™€ í† í°ê°’ì„ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ë§Œë“¤ì–´ ë³´ë‚´ê³¤ í•œë‹¤. ex) "Authorization": "Bearer (token)"

- context

ëª¨ë“  resolverì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì •ë³´ë¥¼ ë„£ì„ ìˆ˜ ìˆëŠ” ê°ì²´, contextì— ëŒ€í•œ ì„¤ì •ì€ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ëŠ” Apollo Server ìƒì„±ìì—ì„œ ì´ë£¨ì–´ì§€ë©°, í•¨ìˆ˜ ë˜ëŠ” ê°ì²´ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë‹¤.  
ì•ì„œ ì ì—ˆë˜ queryë‚˜ mutationì˜ argumentë¡œ tokenì„ ì „ë‹¬í•˜ëŠ” ë°©ë²• ëŒ€ì‹  contextì— token ë˜ëŠ” tokenìœ¼ë¡œ ì°¾ì€ userë¥¼ ë„£ì–´ì¤Œìœ¼ë¡œì¨ mutationì´ë‚˜ queryì— ì¼ì¼íˆ argumentë¡œ ì „ë‹¬í•˜ì§€ ì•Šê³ ë„ resolverì—ì„œ contextë¥¼ í†µí•´ tokenì´ë‚˜ userë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

```ts
const server = new ApolloServer({
  schema,
  context: async ({ req }) => {
    return {
      client,
      user: await getUser(req.headers.authorization || null),
    };
  },
});
```

- getUser function

Apollo Server ìƒì„±ìì—ì„œ contextì— ëŒ€í•œ ì„¤ì •ì„ í•  ë•Œ request headerì— ë‹´ê¸´ tokenì„ ì´ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ ì°¾ì•„ì„œ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ì‘ì„±í•˜ì. ì´ë ‡ê²Œ í•˜ë©´ ë§¤ ìš”ì²­ë§ˆë‹¤ resolverì—ì„œ ë¡œê·¸ì¸í•œ ìœ ì €ì˜ ì •ë³´ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. (tokenì´ ì—†ê±°ë‚˜ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ null)

```ts
import jwt from 'jsonwebtoken';
import client from '../client';
import { TokenType } from '../type';

export const getUser = async (token: string | null) => {
  if (!token) {
    return null;
  }
  const { id } = jwt.verify(
    token,
    process.env.SECRET_KEY as string
  ) as TokenType;

  const user = await client.user.findUnique({
    where: {
      id,
    },
  });

  if (!user) {
    return null;
  } else {
    return user;
  }
};
```

## tips

## issue

- none

## dependencies

## devDependencies

# 18 Protecting Resolvers

## log

- request headerì˜ í† í° ì—¬ë¶€ì— ë”°ë¼ contextì— ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ë¥¼ ë‹´ì„ ìˆ˜ ìˆê²Œ ëì§€ë§Œ resolverì—ì„œ ì´ë¥¼ ë°”ë¡œ ì‚¬ìš©í•˜ê¸°ì—” nullì¸ ê²½ìš°ë„ ì¡´ì¬í•˜ë‹ˆ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ê°€ nullì¸ì§€ ì•„ë‹Œì§€ í™•ì¸í•˜ëŠ” ì¥ì¹˜ê°€ í•„ìš”í•˜ë‹¤.

contextì—ì„œ loggedInUser(= ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´)ê°€ nullì¸ì§€ íŒë‹¨í•˜ëŠ” ì¡°ê±´ë¬¸ì„ í†µí•˜ì—¬ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ë„ ìˆê² ì§€ë§Œ ì´ëŸ¬ë©´ ëª¨ë“  resolverì— ì´ ì¡°ê±´ë¬¸ì„ ë°˜ë³µí•´ì„œ ì ì–´ì¤˜ì•¼ í•œë‹¤. ë°˜ë³µí•´ì„œ ì ëŠ”ê²Œ ë¬¸ì œë¼ë©´ ì´ë¥¼ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ìœ í‹¸ í•¨ìˆ˜ë¡œ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•´ë³´ì.

```ts
// users.utils.ts
export const protectedResolver = (user: User | null) => {
  if (!user) {
    throw new Error('You need to login.');
  }
};
```

ë­”ê°€ ì¡°ê¸ˆ ì•„ì‰½ë‹¤. Error ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ë˜ì§€ê¸° ë³´ë‹¤ëŠ” í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ì´ìš©í•  ìˆ˜ ìˆê²Œ ë”°ë¡œ ë§Œë“  output typeì„ ë§Œë“¤ì–´ì„œ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ë‹´ì•„ ì‘ë‹µìœ¼ë¡œ ë³´ë‚´ê³  ì‹¶ë‹¤. ì´ë¥¼ ìœ„í•´ resolverë¥¼ wrapí•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤. ë¦¬ë•ìŠ¤ì—ì„œë„ ì‚¬ìš©í•˜ëŠ” thunk íŒ¨í„´. ì¦‰, í•¨ìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤.

```ts
// example
const protectedResolver = (resolver) => (root, args, ctx, info) => {
  if (!ctx.loggedInUser) {
    // ...
  }
  return resolver(root, args, ctx, info);
};
```

ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ë¥¼ ì²´í¬í•˜ê³  graphql resolver(í•¨ìˆ˜)ë¥¼ ë°˜í™˜í•´ì£¼ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“¤ì—ˆë‹¤. ì´ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ resolverë¥¼ ê°ì‹¼ ë’¤ì— í˜¸ì¶œí•´ì¤€ë‹¤. **í˜¸ì¶œ**í•´ì¤¬ë‹¤ëŠ” ì ì´ ì¤‘ìš”í•˜ë‹¤. ì´ë¯¸ í•œë²ˆ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí–ˆìœ¼ë‹ˆ protectedResolverê°€ ë°˜í™˜í•œ í•¨ìˆ˜ëŠ” ì „í˜•ì ì¸ graphql resolverì¸ ìƒíƒœì´ë‹¤. (protectedResolverê°€ root, args, ctx, infoë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ëŠ” í•¨ìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì—)

```ts
Mutation: {
    editProfile: protectedResolver(resolver),
}
```

ë‹¨, ì£¼ì˜í•  ì ì€ ë¡œê·¸ì¸ ìœ ë¬´ë¥¼ íŒë‹¨í•˜ê¸° ìœ„í•´ protectedResolverë¡œ ê°ì‹¼ resolverë“¤ì˜ ë°˜í™˜ íƒ€ì…ì€ ëª¨ë‘ ë™ì¼í•´ì•¼í•œë‹¤ëŠ” ì ì´ë‹¤. protectedResolver í•¨ìˆ˜ì—ì„œ ë¡œê·¸ì¸í•œ ìœ ì € ì •ë³´ê°€ ì—†ì„ ê²½ìš° ok, errorê°€ ë‹´ê¸´ ê°ì²´ë¥¼ ë°˜í™˜í•  ê²ƒì´ê¸° ë•Œë¬¸ì— ğŸ‘

```ts
type NotLogggedInResult = {
  ok: boolean;
  error: string;
};

export function protectedResolver(resolver: Resolver): Resolver {
  return function (root, args, ctx, info): Resolver | NotLogggedInResult {
    if (!ctx.loggedInUser) {
      return {
        ok: false,
        error: 'Please log in to perform this action',
      };
    }
    return resolver(root, args, ctx, info);
  };
}
```

## tips

## issue

- none

## dependencies

## devDependencies

# 19 File Upload

## log

- User modelì— bio, avatar ì»¬ëŸ¼ ì¶”ê°€
- Apolloê°€ ì´ì   file uploadë¥¼ ì§€ì›í•œë‹¤.

ì´ì „ì—ëŠ” ëŠ˜ìƒ ê·¸ë˜ì™”ë“¯ì´ REST APIë¥¼ ì‘ì„±í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ì—ì„œ íŒŒì¼ì„ ì—…ë¡œë“œ(íŒŒì¼ì„ ë‹´ì•„ ìš”ì²­ì„ ë³´ë‚´ë©´)í•˜ë©´ ë°±ì—”ë“œê°€ íŒŒì¼ì„ ë°›ì•„ AWS S3 ê°™ì€ ì™¸ë¶€ ì €ì¥ì†Œì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  íŒŒì¼ì˜ URL ì£¼ì†Œë¥¼ ë°›ì•„ì˜¨ë‹¤. ì´ URL ì£¼ì†Œë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê±°ë‚˜ graphql mutationê³¼ í•¨ê»˜ url ì£¼ì†Œë¥¼ ë‚´ë³´ë‚´ëŠ” ë°©ì‹ì´ë‹¤.

- Graphqlë¡œ íŒŒì¼ ì—…ë¡œë“œë¥¼ í•˜ê¸° ìœ„í•´ì„  Uploadë¼ëŠ” íƒ€ì…ì„ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ë° ì´ëŠ” Apollo Serverê°€ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ ë•Œ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ì„œ ì§€ì›í•˜ëŠ” íƒ€ì…ì´ë‹¤. ì¦‰, Apollo Serverê°€ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ì§€ ì•ŠëŠ” ì´ìƒ ë”°ë¡œ ë§Œë“¤ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ, ê¸°ì¡´ì— graphql-toolsë¥¼ ì´ìš©í•´ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ë§Œë“œëŠ” ë°©ì‹ì—ì„œ Apollo Serverê°€ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ë§Œë“¤ë„ë¡ ë³€ê²½í•œë‹¤.

- ì‹¤ì œë¡œ ì„œë²„ì— ì—…ë¡œë“œí•œ íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ê²½ìš°ëŠ” ì—†ë‹¤. ì—¬ëŸ¬ ì„œë²„ë¥¼ ê°€ë™í•  ìˆ˜ë„ ìˆê³  ì„œë²„ë¥¼ ì§€ìš°ê³  ë‹¤ë¥¸ ì„œë²„ë¥¼ í™œì„±í™” ì‹œí‚¤ëŠ” ê²½ìš°ë„ ìˆê³  ë‹¤ë¥¸ ì´ìœ ë„ ìˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì™¸ë¶€ ì €ì¥ì†Œì— íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì§€ë§Œ ì´í›„ì— ì„œë²„ë¥¼ AWS ê°™ì€ ê³³ì— ì˜¬ë¦´ ë•Œ ê·¸ë ‡ê²Œ ì§„í–‰í•˜ë„ë¡ í•˜ê³  í˜„ì¬ëŠ” node.jsë¥¼ ì´ìš©í•´ ì„œë²„ì— íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰

- node 14ì™€ apollo server ë‚´ì˜ graphql-uploadì˜ ì˜¤ë˜ëœ ë²„ì „ì´ í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ apollo-serverì—ì„œ apollo-server-expressë¡œ ë³€ê²½í•˜ì—¬ graphql-uploadë¥¼ ë‹¤ë£° ìˆ˜ ìˆëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ì¶”ê°€í•˜ê³  uploadì˜ íƒ€ì…ê³¼ resolverë¥¼ ë”°ë¡œ ì‘ì„±í•´ì„œ schemaì— ì¶”ê°€í•´ì¤€ë‹¤.

- uploads í´ë”

ì„œë²„ ë‚´ í´ë”ì¸ uploadsì— node.js íŒŒì¼ ì‹œìŠ¤í…œì„ ì´ìš©í•˜ì—¬ íŒŒì¼ì„ ì €ì¥í•˜ì˜€ë‹¤ê³  í•´ë„ í˜„ì¬ì˜ apollo-serverë¡œëŠ” í•´ë‹¹ í´ë”ë¥¼ ì½ê³  ì‚¬ìš©ìê°€ ìš”ì²­í•˜ëŠ” íŒŒì¼ì„ ì°¾ì„ ìˆ˜ê°€ ì—†ë‹¤. (apollo serverì— ê·¸ëŸ° ì„¤ì •ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ) ë”°ë¼ì„œ, ì´ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•˜ê¸° ìœ„í•´ (ì´ë¯¸ ì•ì„œ graphql-upload ë•Œë¬¸ì— ë³€ê²½í–ˆì§€ë§Œ) apollo-server ìœ„ì— express ì„œë²„ë¥¼ ë‘ëŠ” í˜•ì‹ì¸ apollo-server-expressë¡œ ì„œë²„ë¥¼ ë³€ê²½í•œë‹¤.  
ì„¤ì •ì´ í¬ê²Œ ë‹¬ë¼ì§€ì§„ ì•ŠëŠ”ë‹¤. Apollo Serverë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ê²Œ ì•„ë‹ˆë¼ express ì„œë²„ë¥¼ ì¶”ê°€ë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì´ë‹¤.

```ts
const { filename, createReadStream } = (await avatar) as GraphQLFileUpload;
const readStream = createReadStream();

const writeStream = createWriteStream(
  path.join(process.cwd(), 'uploads', filename)
);
readStream.pipe(writeStream);
```

## tips

- Altair

Graphql playgroundë³´ë‹¤ ë” ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì œê³µí•´ì£¼ëŠ” playground? ë¼ê³  ìƒê°í•˜ë©´ ëœë‹¤. Graphql playgroundì—ì„œëŠ” íŒŒì¼ ì—…ë¡œë“œë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìœ¼ë‹ˆ Altairë¡œ ë„˜ì–´ê°€ì„œ ì§„í–‰

- GraphQLFileUpload type

```ts
import { ReadStream } from 'fs-capacitor';

export interface GraphQLFileUpload {
  filename: string;
  mimetype: string;
  encoding: string;
  createReadStream(options?: {
    encoding?: string;
    highWaterMark?: number;
  }): ReadStream;
}
```

## issue

- nodemon ì„œë²„ í¬íŠ¸ ê²¹ì¹˜ëŠ” ì—ëŸ¬

ì„œë²„ë¥¼ ì¬ì‹œì‘í•  ë•Œ ì´ì „ì— ì‹¤í–‰í–ˆë˜ processê°€ ì•„ì§ ì¢…ë£Œë˜ì§€ ì•Šì•„ì„œ ìƒê¸°ëŠ” ë¬¸ì œë¡œ nodemonì—ê²Œ delay ì˜µì…˜ì„ ì¤Œìœ¼ë¡œì¨ í•´ê²°í•  ìˆ˜ ìˆë‹¤.

- node 14í•˜ê³  apollo server file upload ì—ëŸ¬

Apollo ê³µì‹ ë¬¸ì„œì—ë„ ë‚˜ì™€ìˆëŠ” ì‚¬í•­ì¸ë° Apollo Server ë‚´ì—ì„œ graphql-uploadsì˜ ì˜¤ë˜ëœ ë²„ì „ì„ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— node 14í•˜ê³  í˜¸í™˜ì´ ì œëŒ€ë¡œ ë˜ì§€ ì•ŠëŠ”ë‹¤. Apollo Serverì˜ ë‹¤ìŒ ë²„ì „ì—ì„œëŠ” ì´ upload scalarëŠ” ì—†ì–´ì§ˆ ì˜ˆì •ì´ë©°, í–‰ì—¬ë‚˜ ì´ uploadë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ apollo serverì˜ uploadë¥¼ ë§‰ê³  ë”°ë¡œ graphql-uploadsì˜ ìµœì‹  ë²„ì „ì„ ì„¤ì¹˜í•˜ì—¬ serverì— ì¶”ê°€í•´ì„œ ì‚¬ìš©í•  ê²ƒì„ ê¶Œì¥í•˜ê³  ìˆë‹¤.

## dependencies

## devDependencies

# 20 Change Avatar

## log

- ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•˜ëŠ” íŒŒì¼ëª…ì´ ê²¹ì¹˜ëŠ” ê²½ìš°ë¥¼ ìƒê°í•´ì„œ ë‚˜ë¦„? ê³ ìœ í•œ íŒŒì¼ëª…ì„ ë§Œë“¤ì–´ ì£¼ì.

ì„œë²„ì— íŒŒì¼ì„ ì €ì¥í•˜ëŠ” ê²ƒì€ ì •ìƒì ì¸ ë°©ë²•ì´ ì•„ë‹ˆë‹¤. ê·¸ì € ìµìˆ™í•´ì§€ëŠ” ê³¼ì •ì„ ê²ªê¸° ìœ„í•´ ì´ë ‡ê²Œ ì§„í–‰  
ì´í›„ì—ëŠ” AWSì— ì—…ë¡œë“œí•˜ì—¬ ì €ì¥ëœ URL ê²½ë¡œë¥¼ ë°›ì•„ì™€ ì‚¬ìš©í•œë‹¤.

```ts
let avatarUrl = null;
if (avatar) {
  const { filename, createReadStream } = (await avatar) as GraphQLFileUpload;
  const newFilename = `${loggedInUser.id}-${Date.now()}-${filename}`;
  const readStream = createReadStream();

  const writeStream = createWriteStream(
    path.join(process.cwd(), 'uploads', newFilename)
  );
  readStream.pipe(writeStream);
  avatarUrl = `http://localhost:4000/static/${newFilename}`;
}
```

## tips

## issue

- none

## dependencies

## devDependencies
